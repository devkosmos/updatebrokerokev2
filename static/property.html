<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Объект недвижимости - BROKEROK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        /* Стили для модального окна авторизации */
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #f1f5f9;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .auth-tab:hover:not(.active) {
            color: var(--dark);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --warning: #f59e0b;
            --warning-dark: #d97706;
            --dark: #0f172a;
            --light: #ffffff;
            --gray: #64748b;
            --gray-light: #f1f5f9;
            --crypto-blue: #3b82f6;
            --crypto-green: #10b981;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-light);
            color: var(--dark);
            padding-top: 70px;
        }

        .navbar {
            background: var(--light);
            box-shadow: var(--shadow-sm);
            position: fixed;
            top: 0; width: 100%; z-index: 1000;
            height: 70px;
            border-bottom: 1px solid #e9ecef;
        }

        .navbar-container {
            max-width: 1400px; margin: 0 auto; padding: 0 40px;
            height: 100%; display: flex; justify-content: space-between; align-items: center;
        }

        .logo {
            font-size: 24px; font-weight: 900; color: var(--primary);
            text-decoration: none;
        }

        .container {
            max-width: 1200px; margin: 0 auto; padding: 40px;
        }

        .property-grid {
            display: grid; grid-template-columns: 2fr 1fr; gap: 30px;
        }

        .gallery {
            background: white; border-radius: var(--radius); overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .main-image {
            width: 100%; height: 450px; object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .thumbnails {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px; padding: 15px;
        }

        .thumbnail {
            width: 100%; height: 70px; object-fit: cover; border-radius: 8px;
            cursor: pointer; border: 2px solid transparent;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            font-size: 12px;
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .thumbnail.active { border-color: var(--primary); }

        .sidebar { display: flex; flex-direction: column; gap: 20px; }

        .card {
            background: white; border-radius: var(--radius); padding: 25px;
            box-shadow: var(--shadow-sm);
        }

        .price { font-size: 32px; font-weight: 900; color: var(--primary); margin-bottom: 10px; }
        .title { font-size: 22px; font-weight: 800; margin-bottom: 15px; }

        .features {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;
        }

        .feature { display: flex; align-items: center; gap: 10px; }
        .feature i { color: var(--primary); width: 20px; }
        .feature-label { font-size: 12px; color: var(--gray); display: block; }
        .feature-value { font-weight: 700; font-size: 14px; }

        .btn {
            padding: 14px; border-radius: 10px; border: none; font-weight: 700;
            cursor: pointer; transition: 0.2s; width: 100%; font-size: 15px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-crypto { background: var(--crypto-blue); color: white; margin-top: 20px; }
        .btn-crypto:hover { background: #2563eb; }
        .btn-warning { background: var(--warning); color: white; margin-top: 10px; }
        .btn-warning:hover { background: var(--warning-dark); }
        .btn-secondary { background: #f1f5f9; color: var(--dark); margin-top: 10px; }

        .description { background: white; border-radius: var(--radius); padding: 30px; margin-top: 30px; }
        .description h3 { margin-bottom: 15px; }
        .description p { line-height: 1.7; color: #475569; }

        #map { height: 300px; border-radius: var(--radius); margin-top: 30px; }

        /* CRYPTO PAYMENT MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 3000;
            display: none; align-items: center; justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white; border-radius: 20px; max-width: 500px; width: 100%;
            max-height: 90vh; overflow-y: auto;
            box-shadow: var(--shadow-lg); animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 25px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }

        .modal-body { padding: 25px; }

        .modal-footer {
            padding: 20px; border-top: 1px solid #eee;
            display: flex; gap: 10px; justify-content: flex-end;
        }

        .crypto-info {
            background: #f8fafc; border-radius: 12px; padding: 20px; margin: 20px 0;
            border-left: 4px solid var(--crypto-blue);
        }

        .crypto-address {
            font-family: monospace; background: #0f172a; color: white;
            padding: 15px; border-radius: 8px; margin: 15px 0;
            font-size: 14px; word-break: break-all;
            display: flex; justify-content: space-between; align-items: center;
        }

        .copy-btn {
            background: var(--crypto-blue); color: white; border: none;
            padding: 8px 15px; border-radius: 6px; cursor: pointer;
            font-size: 12px; font-weight: 600;
        }

        .crypto-step {
            display: flex; align-items: flex-start; gap: 15px;
            margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;
        }

        .step-number {
            background: var(--crypto-blue); color: white;
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px; flex-shrink: 0;
        }

        .step-content h4 { margin-bottom: 5px; }

        .qr-code {
            text-align: center; margin: 20px 0;
        }

        .qr-code img {
            width: 200px; height: 200px; border: 1px solid #ddd; border-radius: 8px;
            padding: 10px; background: white;
        }

        /* TIMER */
        .timer {
            background: #fef3c7; color: #92400e; padding: 15px;
            border-radius: 10px; text-align: center; margin: 15px 0;
            font-weight: 700; font-size: 18px;
        }

        .timer.expiring { background: #fee2e2; color: #dc2626; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* STATUS */
        .status {
            padding: 10px 15px; border-radius: 8px; font-weight: 600;
            font-size: 13px; text-align: center;
        }

        .status.pending { background: #fef3c7; color: #92400e; }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.failed { background: #fee2e2; color: #dc2626; }

        /* NOTIFICATION */
        .notification {
            position: fixed; top: 90px; right: 30px; background: white; padding: 20px;
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid var(--secondary); display: none; z-index: 3000;
            max-width: 300px; animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* CHAT WINDOW */
        .chat-window {
            position: fixed; bottom: 20px; right: 20px;
            width: 350px; height: 500px;
            background: white; border-radius: var(--radius);
            box-shadow: var(--shadow-lg); z-index: 2000;
            display: none; flex-direction: column;
        }

        .chat-window.active { display: flex; }

        .chat-header {
            background: var(--primary); color: white;
            padding: 15px; border-radius: var(--radius) var(--radius) 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }

        .chat-messages {
            flex: 1; padding: 15px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 10px;
        }

        .message {
            max-width: 80%; padding: 10px 15px; border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-end; background: var(--primary); color: white;
        }

        .message.manager {
            align-self: flex-start; background: #f1f5f9; color: var(--dark);
        }

        .chat-input {
            padding: 15px; border-top: 1px solid #eee;
            display: flex; gap: 10px;
        }

        .chat-input input {
            flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
        }

        .image-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            padding: 20px;
        }

        .thumbnail-placeholder {
            width: 100%;
            height: 100%;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            font-size: 10px;
            text-align: center;
            padding: 5px;
            border-radius: 6px;
        }

        @media (max-width: 768px) {
            .property-grid { grid-template-columns: 1fr; }
            .container { padding: 20px; }
            .modal { margin: 10px; }
            .chat-window { width: calc(100% - 40px); height: 400px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="logo">BROKEROK</a>
            <a href="/" style="color: var(--primary); text-decoration: none; font-weight: 600;">← На главную</a>
        </div>
    </nav>
    
    <!-- Модальное окно авторизации -->
    <div class="modal-overlay" id="authModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class="fas fa-user"></i> Вход в аккаунт</h3>
                <i class="fas fa-times" style="cursor:pointer" onclick="hideAuthModal()"></i>
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">
                        <i class="fas fa-sign-in-alt"></i> Вход
                    </button>
                    <button class="auth-tab" onclick="switchAuthTab('register')">
                        <i class="fas fa-user-plus"></i> Регистрация
                    </button>
                </div>
                
                <!-- Форма входа -->
                <div id="loginForm" class="auth-form active">
                    <form onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label><i class="fas fa-envelope"></i> Email</label>
                            <input type="email" id="loginEmail" placeholder="your@email.com" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-lock"></i> Пароль</label>
                            <input type="password" id="loginPassword" placeholder="••••••••" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                            <i class="fas fa-sign-in-alt"></i> Войти
                        </button>
                    </form>
                </div>
                
                <!-- Форма регистрации -->
                <div id="registerForm" class="auth-form">
                    <form onsubmit="handleRegister(event)">
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> Имя</label>
                            <input type="text" id="regName" placeholder="Ваше имя" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-envelope"></i> Email</label>
                            <input type="email" id="regEmail" placeholder="your@email.com" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-lock"></i> Пароль</label>
                            <input type="password" id="regPassword" placeholder="Минимум 6 символов" required minlength="6">
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                            <i class="fas fa-user-plus"></i> Зарегистрироваться
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="property-grid">
            <div>
                <div class="gallery">
                    <div id="mainImage" class="main-image">
                        <div class="image-placeholder">Загрузка изображения...</div>
                    </div>
                    <div class="thumbnails" id="thumbnails">
                        <div class="thumbnail-placeholder">Миниатюры появятся здесь</div>
                    </div>
                </div>
                <div class="description">
                    <h3>Описание объекта</h3>
                    <p id="description">Загрузка...</p>
                </div>
                <div id="map"></div>
            </div>

            <div class="sidebar">
                <div class="card">
                    <div class="price" id="price">$0</div>
                    <h1 class="title" id="title">Загрузка...</h1>
                    <div class="features">
                        <div class="feature">
                            <i class="fas fa-bed"></i>
                            <div>
                                <span class="feature-label">Комнаты</span>
                                <span class="feature-value" id="rooms">-</span>
                            </div>
                        </div>
                        <div class="feature">
                            <i class="fas fa-ruler-combined"></i>
                            <div>
                                <span class="feature-label">Площадь</span>
                                <span class="feature-value" id="area">0 м²</span>
                            </div>
                        </div>
                        <div class="feature">
                            <i class="fas fa-building"></i>
                            <div>
                                <span class="feature-label">Этаж</span>
                                <span class="feature-value" id="floor">-</span>
                            </div>
                        </div>
                        <div class="feature">
                            <i class="fas fa-city"></i>
                            <div>
                                <span class="feature-label">Город</span>
                                <span class="feature-value" id="city">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Основные кнопки -->
                    <button class="btn btn-crypto" onclick="showCryptoPayment()">
                        <i class="fas fa-coins"></i> Купить за криптовалюту
                    </button>
                    
                    <button class="btn btn-primary" onclick="requestTraditionalPurchase()">
                        <i class="fas fa-shopping-cart"></i> Традиционная покупка
                    </button>
                    
                    <button class="btn btn-secondary" onclick="toggleChat()">
                        <i class="fas fa-comment"></i> Связаться с менеджером
                    </button>
                </div>

                <!-- Блок "Преимущества крипто-платежей" -->
                <div class="card">
                    <h3 style="margin-bottom: 15px; color: var(--crypto-blue);">
                        <i class="fas fa-bolt"></i> Преимущества крипто-платежей
                    </h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 10px; padding-left: 25px; position: relative;">
                            <i class="fas fa-check-circle" style="color: var(--crypto-green); position: absolute; left: 0;"></i>
                            <strong>Мгновенная оплата</strong> - без банков и посредников
                        </li>
                        <li style="margin-bottom: 10px; padding-left: 25px; position: relative;">
                            <i class="fas fa-check-circle" style="color: var(--crypto-green); position: absolute; left: 0;"></i>
                            <strong>Анонимность</strong> - не нужно раскрывать личные данные
                        </li>
                        <li style="margin-bottom: 10px; padding-left: 25px; position: relative;">
                            <i class="fas fa-check-circle" style="color: var(--crypto-green); position: absolute; left: 0;"></i>
                            <strong>Низкие комиссии</strong> - до 10 раз ниже банковских
                        </li>
                        <li style="padding-left: 25px; position: relative;">
                            <i class="fas fa-check-circle" style="color: var(--crypto-green); position: absolute; left: 0;"></i>
                            <strong>Круглосуточно</strong> - оплата в любое время
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно крипто-платежа -->
    <div class="modal-overlay" id="cryptoModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-coins"></i> Оплата криптовалютой</h2>
                <i class="fas fa-times" style="cursor:pointer" onclick="hideCryptoPayment()"></i>
            </div>
            <div class="modal-body">
                <div class="crypto-info">
                    <h3 id="cryptoPropertyTitle">Объект: Загрузка...</h3>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <div>
                            <div style="font-size: 12px; color: var(--gray);">Сумма в USD</div>
                            <div id="cryptoUsdAmount" style="font-size: 24px; font-weight: 900; color: var(--primary);">$0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--gray);">Сумма в USDT</div>
                            <div id="cryptoTokenAmount" style="font-size: 24px; font-weight: 900; color: var(--crypto-blue);">0 USDT</div>
                        </div>
                    </div>
                </div>

                <!-- Таймер -->
                <div class="timer" id="paymentTimer">
                    <i class="fas fa-clock"></i> Время на оплату: <span id="timer">15:00</span>
                </div>

                <!-- Шаги оплаты -->
                <div class="crypto-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Скопируйте адрес кошелька</h4>
                        <p>Отправьте точную сумму на указанный ниже адрес</p>
                        <div class="crypto-address">
                            <span id="cryptoAddress">0x0000000000000000000000000000000000000000</span>
                            <button class="copy-btn" onclick="copyCryptoAddress()">
                                <i class="fas fa-copy"></i> Копировать
                            </button>
                        </div>
                        <p style="font-size: 12px; color: var(--gray);">
                            Сеть: <strong id="cryptoNetwork">ERC-20</strong> |
                            Валюта: <strong id="cryptoCurrency">USDT</strong>
                        </p>
                    </div>
                </div>

                <!-- QR-код -->
                <div class="qr-code">
                    <h4>Или отсканируйте QR-код</h4>
                    <div id="qrcode">
                        <div style="display: flex; justify-content: center; align-items: center; 
                                    width: 200px; height: 200px; border: 1px solid #ddd; 
                                    background: white; margin: 0 auto;">
                            <div style="text-align: center;">
                                <div style="font-size: 14px; margin-bottom: 10px;">USDT Address:</div>
                                <div style="font-family: monospace; font-size: 10px; word-break: break-all;">
                                    0x0000...0000
                                </div>
                                <div style="font-size: 16px; font-weight: bold; margin-top: 10px;">
                                    0 USDT
                                </div>
                            </div>
                        </div>
                    </div>
                    <p style="font-size: 12px; color: var(--gray); margin-top: 10px;">
                        QR-код содержит адрес и сумму
                    </p>
                </div>

                <div class="crypto-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>Введите хэш транзакции</h4>
                        <p>После отправки платежа введите Transaction Hash (TX ID)</p>
                        <input type="text" id="txHash" placeholder="0x123...abc" 
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-top: 10px;">
                        <p style="font-size: 12px; color: var(--gray); margin-top: 5px;">
                            Можно найти в истории транзакций вашего кошелька
                        </p>
                    </div>
                </div>

                <!-- Статус платежа -->
                <div class="status pending" id="paymentStatus">
                    <i class="fas fa-sync-alt fa-spin"></i> Ожидаем оплату...
                </div>

                <!-- Информация о скидке -->
                <div style="background: #d1fae5; padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <h4><i class="fas fa-gift"></i> Специальное предложение!</h4>
                    <p>При оплате криптовалютой вы получаете <strong>скидку 3%</strong> и приоритетное рассмотрение заявки.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideCryptoPayment()">
                    Отмена
                </button>
                <button class="btn btn-primary" onclick="submitCryptoPayment()">
                    <i class="fas fa-check"></i> Подтвердить оплату
                </button>
            </div>
        </div>
    </div>

    <!-- Чат с менеджером -->
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div>
                <h4 style="margin: 0;"><i class="fas fa-comment"></i> Чат с менеджером</h4>
                <small id="chatPropertyTitle" style="opacity: 0.8;"></small>
            </div>
            <i class="fas fa-times" style="cursor:pointer" onclick="toggleChat()"></i>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message manager">
                Здравствуйте! Я менеджер BROKEROK. Чем могу помочь?
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Введите сообщение..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
            <button class="btn btn-primary" style="width: auto; padding: 0 20px;" onclick="sendChatMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Уведомление об успехе -->
    <div class="notification" id="successNotification">
        <h4 style="margin-bottom: 5px; color: var(--secondary);">
            <i class="fas fa-check-circle"></i> Успешно!
        </h4>
        <p id="successMessage" style="font-size: 13px;"></p>
    </div>

<script>
    const propertyId = new URLSearchParams(window.location.search).get('id') || window.location.pathname.split('/').pop();
    let propertyData = null;
    let paymentTimer = null;
    let timeLeft = 15 * 60; // 15 минут в секундах
    let currentUser = null;
    let chatId = null;

    // Проверяем авторизацию при загрузке страницы
// Исправленная функция проверки авторизации
async function checkAuth(silent = false) {
    console.log('Проверка авторизации...');
    const token = localStorage.getItem('access_token');
    if (!token) {
        console.log('Токен не найден в localStorage');
        currentUser = null;
        if (!silent) showAuthModal();
        return false;
    }

    try {
        const response = await fetch('/api/check-session', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        console.log('Статус ответа check-session:', response.status);
        
        const data = await response.json();
        console.log('Данные check-session:', data);
        
        if (data.valid && data.user) {
            currentUser = data.user;
            console.log('Пользователь авторизован:', currentUser.email);
            hideAuthModal();
            return true;
        } else {
            console.log('Сессия недействительна');
            currentUser = null;
            localStorage.removeItem('access_token');
            if (!silent) showAuthModal();
            return false;
        }
    } catch (error) {
        console.error('Ошибка проверки авторизации:', error);
        currentUser = null;
        localStorage.removeItem('access_token');
        if (!silent) showAuthModal();
        return false;
    }
}

// Исправленная функция показа крипто-платежа
async function showCryptoPayment() {
    console.log('Показать крипто-платеж');
    
    // Проверяем авторизацию без показа окна
    const isAuth = await checkAuth(true);
    
    if (!isAuth) {
        console.log('Пользователь не авторизован, показываем окно авторизации');
        showAuthModal();
        return;
    }

    if (!propertyData) {
        alert('Информация об объекте не загружена');
        return;
    }

    // Проверяем статус объекта
    if (propertyData.status === 'sold') {
        alert('Этот объект уже продан!');
        return;
    }

    console.log('Загружаем настройки крипто-кошелька...');
    await loadCryptoWalletSettings();
    
    // Обновляем UI модального окна
    document.getElementById('cryptoPropertyTitle').textContent = `Объект: ${propertyData.title}`;
    const usdAmount = propertyData.price;
    document.getElementById('cryptoUsdAmount').textContent = `$${usdAmount.toLocaleString()}`;
    
    // Расчет суммы в USDT (примерный курс)
    const usdtAmount = usdAmount * 0.97; // Скидка 3%
    document.getElementById('cryptoTokenAmount').textContent = `${usdtAmount.toFixed(2)} USDT`;
    
    // Обновляем QR-код
    updateQRCode(usdtAmount);
    
    // Запускаем таймер
    startPaymentTimer();
    
    // Показываем модальное окно
    document.getElementById('cryptoModal').classList.add('active');
}
    async function loadProperty() {
        try {
            console.log('Загрузка объекта с ID:', propertyId);
            const res = await fetch(`/api/properties/${propertyId}`);
            if (res.ok) {
                propertyData = await res.json();
                console.log('Данные объекта получены:', propertyData);
                
                // Проверяем статус объекта
                if (propertyData.status === 'sold') {
                    alert('Этот объект уже продан!');
                }
                
                updatePropertyUI();
            } else {
                console.error('Ошибка загрузки объекта, статус:', res.status);
                const errorText = await res.text();
                console.error('Текст ошибки:', errorText);
                alert('Объект не найден или удален');
            }
        } catch (error) {
            console.error('Ошибка загрузки объекта:', error);
            alert('Ошибка загрузки данных объекта');
        }
    }

    function updatePropertyUI() {
        if (!propertyData) {
            console.log('propertyData пустой');
            return;
        }
        
        console.log('Обновление UI объекта');
        
        document.getElementById('title').textContent = propertyData.title;
        document.getElementById('price').textContent = `$${propertyData.price.toLocaleString()}`;
        document.getElementById('description').textContent = propertyData.description || 'Нет описания';
        document.getElementById('rooms').textContent = propertyData.rooms || '-';
        document.getElementById('area').textContent = `${propertyData.area || '0'} м²`;
        document.getElementById('floor').textContent = `${propertyData.floor || '-'}/${propertyData.total_floors || '-'}`;
        document.getElementById('city').textContent = propertyData.city;
        
        const mainImgContainer = document.getElementById('mainImage');
        const thumbnailsContainer = document.getElementById('thumbnails');
        
        // Очищаем контейнеры
        mainImgContainer.innerHTML = '';
        thumbnailsContainer.innerHTML = '';
        
        // Обрабатываем изображения
        let images = [];
        
        if (propertyData.images) {
            if (typeof propertyData.images === 'string') {
                try {
                    images = JSON.parse(propertyData.images);
                } catch (e) {
                    if (propertyData.images.trim()) {
                        images = [propertyData.images];
                    }
                }
            } else if (Array.isArray(propertyData.images)) {
                images = propertyData.images;
            }
        }
        
        console.log('Изображения для отображения:', images);
        
        if (images && images.length > 0) {
            console.log(`Найдено ${images.length} изображений`);
            
            // Отображаем первое изображение как основное
            const firstImage = images[0];
            displayImage(firstImage, mainImgContainer, true);
            
            // Создаем миниатюры
            images.forEach((imageUrl, index) => {
                createThumbnail(imageUrl, index, thumbnailsContainer);
            });
            
        } else {
            console.log('Нет изображений, создаем placeholder');
            createImagePlaceholder(mainImgContainer, propertyData.title);
            
            const placeholder = document.createElement('div');
            placeholder.className = 'thumbnail-placeholder';
            placeholder.textContent = 'Нет изображений';
            placeholder.style.display = 'flex';
            placeholder.style.alignItems = 'center';
            placeholder.style.justifyContent = 'center';
            placeholder.style.width = '100%';
            placeholder.style.height = '70px';
            placeholder.style.background = '#f1f5f9';
            placeholder.style.borderRadius = '8px';
            placeholder.style.color = 'var(--gray)';
            placeholder.style.fontSize = '12px';
            thumbnailsContainer.appendChild(placeholder);
        }
        
        // Инициализируем карту
        if (propertyData.latitude && propertyData.longitude) {
            initMap(propertyData.latitude, propertyData.longitude);
        }
    }

    function displayImage(imageUrl, container, isMain = false) {
        console.log(`Отображение изображения: ${imageUrl}`);
        
        // Проверяем URL изображения
        if (!imageUrl || typeof imageUrl !== 'string') {
            console.log('Некорректный URL изображения');
            createImagePlaceholder(container, isMain ? propertyData.title : 'Изображение');
            return;
        }
        
        // Если URL не начинается с http или /, добавляем /uploads/
        let finalUrl = imageUrl;
        if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/') && !imageUrl.startsWith('data:')) {
            finalUrl = `/uploads/${imageUrl}`;
        } else if (imageUrl.startsWith('uploads/')) {
            finalUrl = `/${imageUrl}`;
        }
        
        console.log(`Финальный URL: ${finalUrl}`);
        
        const img = document.createElement('img');
        img.src = finalUrl;
        img.alt = propertyData.title;
        img.style.width = '100%';
        img.style.height = isMain ? '450px' : '70px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = isMain ? '0' : '6px';
        
        img.onerror = function() {
            console.log(`Ошибка загрузки изображения: ${this.src}`);
            container.innerHTML = '';
            createImagePlaceholder(container, isMain ? propertyData.title : 'Изображение');
        };
        
        img.onload = function() {
            console.log(`Изображение загружено: ${this.src}`);
        };
        
        container.innerHTML = '';
        container.appendChild(img);
    }

    function createThumbnail(imageUrl, index, container) {
        const thumbnail = document.createElement('div');
        thumbnail.className = 'thumbnail';
        thumbnail.style.cursor = 'pointer';
        thumbnail.style.border = '2px solid transparent';
        thumbnail.style.borderRadius = '8px';
        thumbnail.style.overflow = 'hidden';
        thumbnail.style.width = '100px';
        thumbnail.style.height = '70px';
        thumbnail.style.position = 'relative';
        
        const img = document.createElement('img');
        img.src = imageUrl.startsWith('http') || imageUrl.startsWith('/') || imageUrl.startsWith('data:') 
            ? imageUrl 
            : `/uploads/${imageUrl}`;
        img.alt = `Миниатюра ${index + 1}`;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        
        img.onerror = function() {
            console.log(`Ошибка загрузки миниатюры: ${this.src}`);
            this.style.display = 'none';
            
            const placeholder = document.createElement('div');
            placeholder.style.width = '100%';
            placeholder.style.height = '100%';
            placeholder.style.background = '#f1f5f9';
            placeholder.style.display = 'flex';
            placeholder.style.alignItems = 'center';
            placeholder.style.justifyContent = 'center';
            placeholder.style.color = 'var(--gray)';
            placeholder.style.fontSize = '10px';
            placeholder.textContent = 'Изображение';
            
            thumbnail.appendChild(placeholder);
        };
        
        thumbnail.appendChild(img);
        
        thumbnail.onclick = function() {
            // Обновляем основное изображение
            displayImage(imageUrl, document.getElementById('mainImage'), true);
            
            // Обновляем активную миниатюру
            document.querySelectorAll('.thumbnail').forEach(el => {
                el.style.border = '2px solid transparent';
            });
            thumbnail.style.border = '2px solid var(--primary)';
        };
        
        // Делаем первую миниатюру активной
        if (index === 0) {
            thumbnail.style.border = '2px solid var(--primary)';
        }
        
        container.appendChild(thumbnail);
    }

    function createImagePlaceholder(container, text) {
        const placeholder = document.createElement('div');
        placeholder.className = 'image-placeholder';
        placeholder.textContent = text || 'Объект недвижимости';
        placeholder.style.display = 'flex';
        placeholder.style.alignItems = 'center';
        placeholder.style.justifyContent = 'center';
        placeholder.style.width = '100%';
        placeholder.style.height = '450px';
        placeholder.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        placeholder.style.color = 'white';
        placeholder.style.fontWeight = 'bold';
        placeholder.style.fontSize = '18px';
        placeholder.style.textAlign = 'center';
        placeholder.style.padding = '20px';
        
        container.appendChild(placeholder);
    }

    function initMap(lat, lng) {
        try {
            const map = L.map('map').setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            L.marker([lat, lng]).addTo(map)
                .bindPopup(`<b>${propertyData.title}</b><br>${propertyData.address || ''}`)
                .openPopup();
        } catch (error) {
            console.error('Ошибка инициализации карты:', error);
        }
    }

    // Функции для работы с авторизацией
    function switchAuthTab(tab) {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
        
        if (tab === 'login') {
            document.querySelector('.auth-tab[onclick*="login"]').classList.add('active');
            document.getElementById('loginForm').classList.add('active');
        } else {
            document.querySelector('.auth-tab[onclick*="register"]').classList.add('active');
            document.getElementById('registerForm').classList.add('active');
        }
    }

    function showAuthModal() {
        console.log('Показ модального окна авторизации');
        document.getElementById('authModal').classList.add('active');
    }

    function hideAuthModal() {
        console.log('Скрытие модального окна авторизации');
        document.getElementById('authModal').classList.remove('active');
    }

    async function handleLogin(event) {
        event.preventDefault();
        console.log('Обработка входа');
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            });
            
            console.log('Статус ответа login:', response.status);
            
            if (response.ok) {
                const result = await response.json();
                console.log('Успешный вход:', result);
                
                localStorage.setItem('access_token', result.access_token);
                currentUser = result.user;
                hideAuthModal();
                showSuccessNotification('Успешный вход!');
                
                // Обновляем UI
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Ошибка входа');
            }
        } catch (error) {
            console.error('Ошибка входа:', error);
            alert('Ошибка входа: ' + error.message);
        }
    }

    async function handleRegister(event) {
        event.preventDefault();
        console.log('Обработка регистрации');
        
        const name = document.getElementById('regName').value;
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;
        
        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, email, password })
            });
            
            console.log('Статус ответа register:', response.status);
            
            if (response.ok) {
                const result = await response.json();
                console.log('Успешная регистрация:', result);
                
                localStorage.setItem('access_token', result.access_token);
                currentUser = result.user;
                hideAuthModal();
                showSuccessNotification('Регистрация успешна!');
                
                // Обновляем UI
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Ошибка регистрации');
            }
        } catch (error) {
            console.error('Ошибка регистрации:', error);
            alert('Ошибка регистрации: ' + error.message);
        }
    }

    // Крипто-платежи
    async function showCryptoPayment() {
        console.log('Показать крипто-платеж');
        
        // Проверяем авторизацию
        await checkAuth();
        
        if (!currentUser) {
            console.log('Пользователь не авторизован, показываем окно авторизации');
            showAuthModal();
            return;
        }

        if (!propertyData) {
            alert('Информация об объекте не загружена');
            return;
        }

        // Проверяем статус объекта
        if (propertyData.status === 'sold') {
            alert('Этот объект уже продан!');
            return;
        }

        console.log('Загружаем настройки крипто-кошелька...');
        await loadCryptoWalletSettings();
        
        // Обновляем UI модального окна
        document.getElementById('cryptoPropertyTitle').textContent = `Объект: ${propertyData.title}`;
        const usdAmount = propertyData.price;
        document.getElementById('cryptoUsdAmount').textContent = `$${usdAmount.toLocaleString()}`;
        
        // Расчет суммы в USDT (примерный курс)
        const usdtAmount = usdAmount * 0.97; // Скидка 3%
        document.getElementById('cryptoTokenAmount').textContent = `${usdtAmount.toFixed(2)} USDT`;
        
        // Обновляем QR-код
        updateQRCode(usdtAmount);
        
        // Запускаем таймер
        startPaymentTimer();
        
        // Показываем модальное окно
        document.getElementById('cryptoModal').classList.add('active');
    }

    async function loadCryptoWalletSettings() {
    try {
        const token = localStorage.getItem('access_token');
        if (!token) {
            throw new Error('Нет токена авторизации');
        }

        const response = await fetch('/api/crypto/wallet', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        console.log('Статус ответа crypto/wallet:', response.status);
        
        if (response.ok) {
            const wallet = await response.json();
            console.log('Настройки кошелька:', wallet);
            
            if (wallet.wallet_address && wallet.wallet_address !== '') {
                document.getElementById('cryptoAddress').textContent = wallet.wallet_address;
                document.getElementById('cryptoNetwork').textContent = wallet.network || 'ERC-20';
                document.getElementById('cryptoCurrency').textContent = wallet.currency || 'USDT';
            } else {
                // Если кошелек не настроен, используем тестовые данные
                document.getElementById('cryptoAddress').textContent = '0x742d35Cc6634C0532925a3b844Bc9e8006a2e0b8';
                document.getElementById('cryptoNetwork').textContent = 'ERC-20';
                document.getElementById('cryptoCurrency').textContent = 'USDT';
                showSuccessNotification('Кошелек не настроен, используем тестовый адрес');
            }
        } else {
            console.log('Не удалось загрузить настройки кошелька');
            // Используем тестовые данные в случае ошибки
            document.getElementById('cryptoAddress').textContent = '0x742d35Cc6634C0532925a3b844Bc9e8006a2e0b8';
            document.getElementById('cryptoNetwork').textContent = 'ERC-20';
            document.getElementById('cryptoCurrency').textContent = 'USDT';
            showSuccessNotification('Используем тестовый крипто-адрес');
        }
    } catch (error) {
        console.error('Ошибка загрузки кошелька:', error);
        // Используем тестовые данные
        document.getElementById('cryptoAddress').textContent = '0x742d35Cc6634C0532925a3b844Bc9e8006a2e0b8';
        document.getElementById('cryptoNetwork').textContent = 'ERC-20';
        document.getElementById('cryptoCurrency').textContent = 'USDT';
        showSuccessNotification('Ошибка загрузки кошелька, используем тестовый адрес');
    }
}
    function hideCryptoPayment() {
        document.getElementById('cryptoModal').classList.remove('active');
        stopPaymentTimer();
    }

    function copyCryptoAddress() {
        const address = document.getElementById('cryptoAddress').textContent;
        if (address && address !== 'Не настроено') {
            navigator.clipboard.writeText(address).then(() => {
                showSuccessNotification('Адрес скопирован в буфер обмена');
            });
        }
    }

    function updateQRCode(amount) {
        const address = document.getElementById('cryptoAddress').textContent;
        const qrDiv = document.getElementById('qrcode');
        
        // Создаем простой QR код с помощью SVG
        qrDiv.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; 
                        width: 200px; height: 200px; border: 1px solid #ddd; 
                        background: white; margin: 0 auto; border-radius: 8px;
                        flex-direction: column; padding: 15px;">
                <div style="font-size: 14px; margin-bottom: 10px; color: var(--dark);">
                    <i class="fas fa-coins"></i> USDT Address
                </div>
                <div style="font-family: monospace; font-size: 10px; word-break: break-all;
                            background: #f8fafc; padding: 8px; border-radius: 4px;
                            margin-bottom: 10px; text-align: center;">
                    ${address.substring(0, 15)}...${address.substring(address.length - 10)}
                </div>
                <div style="font-size: 18px; font-weight: bold; margin-top: 10px; color: var(--crypto-blue);">
                    ${amount} USDT
                </div>
                <div style="font-size: 10px; color: var(--gray); margin-top: 5px;">
                    Сеть: ${document.getElementById('cryptoNetwork').textContent}
                </div>
            </div>
        `;
    }

    function startPaymentTimer() {
        timeLeft = 15 * 60; // 15 минут
        updateTimerDisplay();
        
        paymentTimer = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft <= 0) {
                stopPaymentTimer();
                document.getElementById('paymentTimer').classList.add('expiring');
                document.getElementById('paymentStatus').innerHTML = '<i class="fas fa-times"></i> Время истекло';
                document.getElementById('paymentStatus').className = 'status failed';
            } else if (timeLeft <= 300) { // 5 минут
                document.getElementById('paymentTimer').classList.add('expiring');
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById('timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function stopPaymentTimer() {
        if (paymentTimer) {
            clearInterval(paymentTimer);
            paymentTimer = null;
        }
    }

    async function submitCryptoPayment() {
        console.log('Подтверждение крипто-платежа');
        
        const txHash = document.getElementById('txHash').value.trim();
        
        if (!txHash) {
            alert('Пожалуйста, введите Transaction Hash');
            return;
        }
        
        if (txHash.length < 10) {
            alert('Transaction Hash слишком короткий');
            return;
        }

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/crypto/purchase', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    property_id: parseInt(propertyId),
                    amount: propertyData.price * 0.97, // С учетом скидки 3%
                    currency: 'USDT',
                    wallet_address: document.getElementById('cryptoAddress').textContent,
                    tx_hash: txHash
                })
            });

            console.log('Статус ответа crypto/purchase:', response.status);
            
            if (response.ok) {
                const result = await response.json();
                console.log('Платеж создан:', result);
                
                // Обновляем UI
                document.getElementById('paymentStatus').innerHTML = '<i class="fas fa-check"></i> Платеж обрабатывается';
                document.getElementById('paymentStatus').className = 'status success';
                
                // Показываем уведомление
                showSuccessNotification('Платеж принят в обработку! Менеджер свяжется с вами для подтверждения.');
                
                // Закрываем модальное окно через 3 секунды
                setTimeout(() => {
                    hideCryptoPayment();
                    toggleChat(); // Открываем чат
                    
                    // Отправляем автоматическое сообщение в чат
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message user';
                    msgDiv.textContent = `Оплатил объект "${propertyData.title}" через криптовалюту. TX Hash: ${txHash}`;
                    document.getElementById('chatMessages').appendChild(msgDiv);
                }, 3000);
            } else {
                const error = await response.json();
                console.error('Ошибка создания платежа:', error);
                throw new Error(error.detail || 'Ошибка создания заказа');
            }
        } catch (error) {
            console.error('Ошибка оплаты:', error);
            document.getElementById('paymentStatus').innerHTML = '<i class="fas fa-times"></i> Ошибка оплаты';
            document.getElementById('paymentStatus').className = 'status failed';
            alert('Ошибка при обработке платежа: ' + error.message);
        }
    }

async function requestTraditionalPurchase() {
    console.log('Запрос традиционной покупки');
    
    const isAuth = await checkAuth(true);
    
    if (!isAuth) {
        console.log('Пользователь не авторизован');
        showAuthModal();
        return;
    }

    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/admin/orders', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                property_id: parseInt(propertyId),
                amount: propertyData.price,
                currency: 'USD',
                note: 'Запрос на традиционную покупку'
            })
        });

        console.log('Статус ответа admin/orders:', response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log('Заказ создан:', result);
            showSuccessNotification('Заявка на покупку отправлена! Менеджер свяжется с вами в ближайшее время.');
            
            // Открываем чат
            setTimeout(() => {
                toggleChat();
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message user';
                msgDiv.textContent = `Хочу приобрести объект "${propertyData.title}" через традиционную оплату`;
                document.getElementById('chatMessages').appendChild(msgDiv);
            }, 1000);
        } else {
            const error = await response.json();
            console.error('Ошибка создания заказа:', error);
            throw new Error('Ошибка создания заявки');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка: ' + error.message);
    }
}
    function showSuccessNotification(message) {
        const notify = document.getElementById('successNotification');
        document.getElementById('successMessage').textContent = message;
        notify.style.display = 'block';
        setTimeout(() => { notify.style.display = 'none'; }, 5000);
    }

    // Чат
    function toggleChat() {
        const chatWindow = document.getElementById('chatWindow');
        chatWindow.classList.toggle('active');
        
        if (chatWindow.classList.contains('active')) {
            document.getElementById('chatPropertyTitle').textContent = propertyData?.title || '';
        }
    }
async function sendChatMessage() {
    console.log('Отправка сообщения в чат');
    
    await checkAuth();
    
    if (!currentUser) {
        console.log('Пользователь не авторизован');
        showAuthModal();
        return;
    }

    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Добавляем сообщение пользователя
    const userMsg = document.createElement('div');
    userMsg.className = 'message user';
    userMsg.textContent = message;
    document.getElementById('chatMessages').appendChild(userMsg);
    
    // Очищаем поле ввода
    input.value = '';
    
    // Прокручиваем вниз
    const messagesDiv = document.getElementById('chatMessages');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/chats', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                property_id: parseInt(propertyId),
                message: message
            })
        });

        console.log('Статус ответа chats:', response.status);
        
        if (!response.ok) {
            console.error('Ошибка отправки сообщения');
        }
        
        // Имитируем ответ менеджера через 2 секунды
        setTimeout(() => {
            const responses = [
                "Спасибо за ваше сообщение! Я свяжусь с вами в ближайшее время.",
                "Хорошо, я принял вашу заявку в работу.",
                "Для уточнения деталей можете указать ваш номер телефона?",
                "Скоро свяжусь с вами для обсуждения деталей."
            ];
            const managerMsg = document.createElement('div');
            managerMsg.className = 'message manager';
            managerMsg.textContent = responses[Math.floor(Math.random() * responses.length)];
            document.getElementById('chatMessages').appendChild(managerMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }, 2000);
        
    } catch (error) {
        console.error('Ошибка отправки сообщения:', error);
        // Даже при ошибке показываем ответ менеджера
        setTimeout(() => {
            const managerMsg = document.createElement('div');
            managerMsg.className = 'message manager';
            managerMsg.textContent = "Ваше сообщение получено. Свяжусь с вами в ближайшее время.";
            document.getElementById('chatMessages').appendChild(managerMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }, 2000);
    }
}
    // Инициализация
window.onload = async function() {
    console.log('Загрузка страницы объекта...');
    console.log('ID объекта из URL:', propertyId);
    
    if (!propertyId || isNaN(propertyId)) {
        alert('Неверный ID объекта');
        window.location.href = '/';
        return;
    }
    
    // Проверяем авторизацию без показа окна
    await checkAuth(true);
    await loadProperty();
};
</script>
</body>
</html>